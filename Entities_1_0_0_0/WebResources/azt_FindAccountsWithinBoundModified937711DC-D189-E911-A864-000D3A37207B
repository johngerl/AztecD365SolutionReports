<html><head>
    <title>Get Location</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <script src="ClientGlobalContext.js.aspx" type="text/javascript"></script>

    <link href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.css" rel="stylesheet" type="text/css">
    <script src="https://code.jquery.com/jquery-3.3.1.js" type="text/javascript" charset="utf8"></script>
    <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.js" type="text/javascript" charset="utf8"></script>
    <!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" crossorigin="anonymous" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"></script> -->
    <!-- <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"> -->
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script> -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.8.1/css/bootstrap-select.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.8.1/js/bootstrap-select.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>


    <style>
        /* Always set the map height explicitly to define the size of the div
        * element that contains the map. */
        #map {
            height: 450px;
        }
        /* Optional: Makes the sample page fill the window. */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #floating-panel {
            position: absolute;
            top: 10px;
            left: 20%;
            z-index: 5;
            background-color: #fff;
            padding: 5px;
            border: 1px solid #999;
            text-align: center;
            font-family: 'Roboto','sans-serif';
            line-height: 30px;
            padding-left: 10px;
        }

        .divTable {
            padding: 14px;
        }
    </style>
    <script src="ClientGlobalContext.js.aspx" type="text/javascript"></script>

    <meta>
    <meta>
    <meta>
    <meta>
    <meta>
    <meta>
    <meta charset="utf-8">
    <meta charset="utf-8">
    <meta>
    <meta>
    <meta>
    <meta>
    <meta>
<meta></head>
<body style="word-wrap: break-word;" onfocusout="parent.setEmailRange();">
    <div id="floating-panel">
        <input id="address" type="textbox" placeholder="Type Address here" value="" style="width:400px;">
        <input id="radius1" type="textbox" placeholder="Enter Radius in Miles" value="">
        <select id="AccoutTypeOptn" class="selectpicker" multiple="" data-live-search="true"></select>
        <input class="btn btn-primary" id="submit" type="button" value="Search">
    </div>
    <div id="map"></div>
    <div class="divTable">
        <table class="table table-hover" id="example" style="width: 100%;">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Parent Account</th>
                    <th>Vertical</th>
                    <th>Account Type</th>
                    <th>Owner</th>
                    <th>Distance</th>
                </tr>
            </thead>
        </table>
    </div>
    <script>
        var map = null;
        var data;
        var table;
        var cityCircle = null;
        var accountMarkers = [];
        var searchedAddMarker = null;
        var searchedLat = null;
        var searchedLng = null;
        var accountDetails = [];

        $(document).ready(function () {
            retrieveEntityMetaData();
            $('#example').on('click', 'a.account,a.user', function () {
                var type = 'account';
                if ($(this).hasClass('user')) {
                    type = 'systemuser';
                }
                openForm($(this).data('id'), type);
            });

        });

        function initMap() {
            var input = document.getElementById('address');
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: { lat: -34.397, lng: 150.644 }
            });
            var geocoder = new google.maps.Geocoder();
            var autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.setFields(
                ['address_components', 'geometry', 'icon', 'name']);


            document.getElementById('submit').addEventListener('click', function () {
                //CallWorkflowAction();
                geocodeAddress(geocoder, map);
            });

        }

        function addMarkerToMap(accountDetails) {
            for (var i = 0; i < accountMarkers.length; i++) {
                accountMarkers[i].setMap(null);
            }
            accountMarkers = [];

            for (var j = 0; j < accountDetails.length; j++) {
                var i = accountDetails[j];
                Latitude = i.Latitude;
                Longitude = i.Longitude;
                if (i.ParentName != null) {
                    accountName = "<b><u>Parent Account Name: </b></u>" + i.ParentName + "<br> <b><u>Account Name: </b></u>" + i.Name;
                }
                else {
                    accountName = "<b><u>Account Name: </b></u>" + i.Name;
                }
                id = i.Id;
                var features = [
                    {
                        position: new google.maps.LatLng(Latitude, Longitude),
                        type: 'account'
                    }
                ];

                var contentString = {
                    account: {
                        contentStr: '<div id="content">'
                            + '<div id="bodyContent">'
                            + accountName + '<br></div><a href="#" onclick= openForm("' + id + '") >Click Here</a> to open Account.</div>'
                    }
                };

                features.forEach(function (feature) {
                    var infowindow = new google.maps.InfoWindow({
                        content: contentString[feature.type].contentStr
                    });

                    var marker = new google.maps.Marker({
                        map: map,
                        position: feature.position,
                        icon: { url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" },
                        title: 'Account'
                    });
                    accountMarkers[accountMarkers.length] = marker;
                    marker.addListener('click', function () {
                        infowindow.open(map, marker);
                    });
                });
            }
            return accountDetails;
        }

        function geocodeAddress(geocoder, resultsMap) {
            var address = document.getElementById('address').value;
            var radius1 = document.getElementById('radius1').value;

            geocoder.geocode({ 'address': address }, function (results, status) {
                if (status === 'OK') {
                    if (searchedAddMarker) { searchedAddMarker.setMap(null); }
                    resultsMap.setCenter(results[0].geometry.location);
                    var marker = new google.maps.Marker({
                        map: resultsMap,
                        position: results[0].geometry.location
                    });
                    searchedLat = results[0].geometry.location.lat();
                    searchedLng = results[0].geometry.location.lng();
                    searchedAddMarker = marker;
                    if (cityCircle) { cityCircle.setMap(null); }
                    cityCircle = new google.maps.Circle({
                        strokeColor: '#FF0000',
                        strokeOpacity: .5,
                        strokeWeight: 2,
                        fillColor: '#000000',
                        fillOpacity: 0.28,
                        center: { lat: results[0].geometry.location.lat(), lng: results[0].geometry.location.lng() },
                        radius: radius1 * 1609.34
                    });
                    cityCircle.setMap(map);
                    var bounds = cityCircle.getBounds();
                    var rightUpLat = bounds.getNorthEast().lat();
                    var rightUpLong = bounds.getNorthEast().lng();
                    var leftLowLat = bounds.getSouthWest().lat();
                    var leftLowLong = bounds.getSouthWest().lng();

                    var output = CallAction(rightUpLat, rightUpLong, leftLowLat, leftLowLong, resultsMap);

                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });
        }

        function openForm(id, entityType) {
            if (!entityType) {
                entityType = "account";
            }
            var windowOptions = {
                openInNewWindow: true
            };
            Xrm.Utility.openEntityForm(entityType, id, null, windowOptions);
        }

        function getDistanceFromLatLonInKm1(lat1, lon1, lat2, lon2, accId) {
            var distance;
            var accountID = accId;
            var origin = new google.maps.LatLng(lat1, lon1);
            var destination = new google.maps.LatLng(lat2, lon2);
            var service = new google.maps.DistanceMatrixService();
            service.getDistanceMatrix(
                {
                    origins: [origin],
                    destinations: [destination],
                    travelMode: 'DRIVING',
                    unitSystem: google.maps.UnitSystem.IMPERIAL,
                    avoidHighways: false,
                    avoidTolls: false
                }, function callback(response, status) {
                    if (status == 'OK') {
                        var origins = response.originAddresses;
                        var destinations = response.destinationAddresses;
                        var results = response.rows[0].elements;
                        var element = results[0];
                        distance = element.distance.text;
                        var duration = element.duration.text;
                        var from1 = origins[0];
                        var to = destinations[0];
                        for (i = 0; i < accountDetails.length; i++) {
                            if (accountDetails[i].Id === accountID) {
                                accountDetails[i].Distance = distance;
                                if (table) {
                                    table.clear().rows.add(accountDetails).draw();
                                }
                            }
                        }
                    }
                });
        }

        function CallAction(rightUpLat, rightUpLong, leftLowLat, leftLowLong, resultsMap) {
            var Accountvalue = $('#AccoutTypeOptn').val().toString();
            var accountName = "";
            var id;
            var Latitude;
            var Longitude;
            var parameters = {};
            parameters.MaxLatitude = rightUpLat;
            parameters.MinLatitude = leftLowLat;
            parameters.MaxLongitude = rightUpLong;
            parameters.MinLongitude = leftLowLong;
            parameters.AccountType = Accountvalue;

            var req = new XMLHttpRequest();
            req.open("POST", Xrm.Page.context.getClientUrl() + "/api/data/v9.1/azt_FindAllAccountWithBoundModified", false);
            req.setRequestHeader("OData-MaxVersion", "4.0");
            req.setRequestHeader("OData-Version", "4.0");
            req.setRequestHeader("Accept", "application/json");
            req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
            req.onreadystatechange = function () {
                if (this.readyState === 4) {
                    req.onreadystatechange = null;
                    if (this.status === 200) {
                        var obj = JSON.parse(this.responseText);
                        if (obj.AccountDetails) {

                            accountDetails = JSON.parse(obj.AccountDetails);
                            for (var i = 0; i < accountDetails.length; i++) {
                                getDistanceFromLatLonInKm1(searchedLat, searchedLng, accountDetails[i].Latitude, accountDetails[i].Longitude, accountDetails[i].Id);
                            }


                            addMarkerToMap(accountDetails);
                            if (!table) {
                                table = $('#example').DataTable({
                                    data: accountDetails,
                                    columns: [
                                        {
                                            data: 'Name',
                                            "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                                                $(nTd).html(oData.Name ? ("<a href='#' class='account' data-id='" + oData.Id + "'>" + oData.Name + "</a>") : "");
                                            }
                                        },
                                        {
                                            data: 'ParentName',
                                            "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                                                $(nTd).html(oData.ParentName ? ("<a href='#' class='account' data-id='" + oData.ParentId + "'>" + oData.ParentName + "</a>") : "");
                                            }
                                        },
                                        { data: 'VerticalMarket' },
                                        { data: 'AccountType' },
                                        {
                                            data: 'OwnerName',
                                            "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                                                $(nTd).html("<a class='user' href='#' data-id='" + oData.OwnerId + "'>" + oData.OwnerName + "</a>");
                                            }
                                        },
                                        { data: 'Distance' }
                                    ]
                                });
                                table.on('search.dt', function () {
                                    //number of filtered rows
                                    console.log(table.rows({ filter: 'applied' }).nodes().length);
                                    var tableData = table.rows({ filter: 'applied' }).data();
                                    addMarkerToMap(tableData);
                                    //filtered rows data as arrays
                                    console.log(tableData);
                                });
                            }
                            else {
                                table.clear().rows.add(accountDetails).draw();
                            }
                        }
                    }
                    else {
                        Xrm.Utility.alertDialog(this.statusText);
                    }

                }
            };
            req.send(JSON.stringify(parameters));
        }

        // ///////////////////////////////////////////////// MyWork///////////////////////////////////////////////
        //this function is used to retrieve entityMetadata
        function retrieveEntityMetaData() {
            var entityName = "";
            try {
                //set variable value
                entityName = "account";
                var data = null;

                //create AJAX request
                $.ajax({
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    datatype: "json",
                    url: encodeURI(Xrm.Page.context.getClientUrl() + "/api/data/v9.0/EntityDefinitions(LogicalName='account')/Attributes(LogicalName='azt_accounttype')/Microsoft.Dynamics.CRM.PicklistAttributeMetadata?$select=LogicalName&$expand=OptionSet($select=Options),GlobalOptionSet($select=Options)"),

                    beforeSend: function (xhr) {
                        //Specifying this header ensures that the results will be returned as JSON.
                        xhr.setRequestHeader("Accept", "application/json");
                        xhr.setRequestHeader("Accept", "application/json");
                        xhr.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                        xhr.setRequestHeader("OData-MaxVersion", "4.0");
                        xhr.setRequestHeader("OData-Version", "4.0");
                    },
                    success: function (data, textStatus, xhr) {
                        //Call successCallback
                        //retrieveEntityMetaDataSuccess(data);
                        var SelectAccountOptionset = document.getElementById("AccoutTypeOptn");
                        //var option = document.createElement("option");
                        var options_count = data.OptionSet.Options.length;
                        for (var i = 0; i < options_count; i++) {
                            var option = document.createElement("option");
                            option.value = data.OptionSet.Options[i].Value;
                            option.text = data.OptionSet.Options[i].Label.UserLocalizedLabel.Label;
                            SelectAccountOptionset.add(option);
                        }
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        alert(xhr);
                    }
                });

            } catch (e) {
                alert(e.message);
            }
        }
////////////////////////////////////////////////////////////////////////////////////////////////////////////

      /////////////////////////////////////////////////////////////////////////////////////////////////////////////


    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCq9l0MJUn3bcY0vfMvZCffT78MwfkWW4Q&amp;&amp;libraries=places&amp;callback=initMap" async="">
    </script>





</body></html>