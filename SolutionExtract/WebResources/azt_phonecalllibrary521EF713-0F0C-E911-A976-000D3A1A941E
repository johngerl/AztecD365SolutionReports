if (typeof (PC) === "undefined") { PC = {}; }
PC.PhoneCallFunctions = {
    onLoad: function (e) {
        debugger;
        var formContext = e.getFormContext();
        var formType = formContext.ui.getFormType();
        if (formType === 1) {
            var lookoupObject = formContext.getAttribute('regardingobjectid');
            if (lookoupObject.getValue() !== null) {
                var regardingId = lookoupObject.getValue()[0].id;
                var formattedregardingId = regardingId.replace('{', '').replace('}', '').toLowerCase();
                var regardingEntityName = lookoupObject.getValue()[0].entityType;
                var regardingName = lookoupObject.getValue()[0].name; //Lookup Name Value
                if (regardingEntityName === "contact") {
                    var serverURL = formContext.context.getClientUrl();
                    var req = new XMLHttpRequest();
                    req.open("GET", serverURL + "/api/data/v9.1/contacts(" + formattedregardingId + ")?$select=telephone1", false);
                    req.setRequestHeader("OData-MaxVersion", "4.0");
                    req.setRequestHeader("OData-Version", "4.0");
                    req.setRequestHeader("Accept", "application/json");
                    req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                    req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                    req.onreadystatechange = function () {
                        if (this.readyState === 4) {
                            req.onreadystatechange = null;
                            if (this.status === 200) {
                                var result = JSON.parse(this.response);
                                var telephone1 = result["telephone1"];
                                if (telephone1 !== null) {
                                    formContext.getAttribute("phonenumber").setValue(telephone1);
                                }
                            } else {
                                Xrm.Utility.alertDialog(this.statusText);
                            }
                        }
                    };
                    req.send();
                }
            }
        }
    },
    setAutoCallbackVisibility: function (e) {
        var formContext = e.getFormContext();
        if (formContext.getAttribute("azt_autocreatecallback").getValue() === true) {
            formContext.getControl("azt_copydescription").setVisible(true);
            formContext.getControl("azt_copysubject").setVisible(true);
            formContext.getControl("azt_addtocrtqueue").setVisible(true);
            formContext.getControl("azt_callbackin").setVisible(true);
            formContext.getAttribute("azt_callbackin").setRequiredLevel("required");
            if (formContext.getAttribute("azt_callbackin").getValue() === 276530005) {
                formContext.getControl("azt_callbackon").setVisible(true);
                formContext.getAttribute("azt_callbackon").setRequiredLevel("required");
            }
            else {
                formContext.getControl("azt_callbackon").setVisible(false);
                formContext.getAttribute("azt_callbackon").setRequiredLevel("none");
            }
        }
        else {
            formContext.getControl("azt_copydescription").setVisible(false);
            formContext.getControl("azt_copysubject").setVisible(false);
            formContext.getControl("azt_addtocrtqueue").setVisible(false);
            formContext.getControl("azt_callbackin").setVisible(false);
            formContext.getControl("azt_callbackon").setVisible(false);
            formContext.getAttribute("azt_callbackin").setRequiredLevel("none");
        }
    }
}